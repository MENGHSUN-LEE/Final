<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <script src="/htmx.min.js"></script>
    <script src="/response-targets.min.js"></script>
    <script src="/remove-me.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            margin: 0;
            width: 100%;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            /* (1) 預設為首頁的卡片樣式 (較小) */
            max-width: 600px;
            min-height: 50vh;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            margin: auto;
            transition: max-width 0.5s, min-height 0.5s, box-shadow 0.5s;
        }

        /* -------------------------------------- */
        /* (2) 針對主功能頁面（/app），將容器放大至全螢幕 */
        body:not(.no-nav) #main {
            align-items: flex-start;
            justify-content: flex-start;
            padding: 0;
        }

        /* (3) 調整主內容區 #main 在全螢幕模式下的行為 */
        body:not(.no-nav) #app-container {
            max-width: 100vw;
            min-height: 100vh;
            margin: 0;
            box-shadow: none;
        }

        /* 讓 Tab 內容區域佔滿 #main 空間，並在內部添加 padding */
        #tab-content {
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            flex-grow: 1;
        }

        /* -------------------------------------- */

        #main {
            display: flex;
            flex-grow: 1;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        #navbar {
            background-color: #343a40;
            padding: 10px 20px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            margin: 0;
        }

        /* ... (Navbar 樣式 & 置中樣式保持不變) ... */
        .no-nav #navbar,
        .no-nav #tab-content {
            display: none;
        }

        .no-nav #main {
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-right: 10px;
            font-weight: bold;
        }

        .nav-link.active,
        .nav-link:hover {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>

<body hx-ext="response-targets, remove-me" hx-target-error="#toast" hx-on::before-swap="doWrap(event)">

    <div id="app-container">
        <nav id="navbar">
            {{{navbar_content}}}
        </nav>

        <main id="main">
            {{{body}}}
        </main>
    </div>

    <div id="toast"></div>

    <script>
        function doWrap(e) {
            if (e.detail.isError) {
                e.detail.serverResponse = `<div remove-me="10s" style="background-color: #dc3545c0; color: yellow;">${e.detail.serverResponse}</div>`;
            }
        }
        // 注意: htmx 腳本已移到 <head>，理論上 htmx.on 應該能生效
        htmx.on("htmx:beforeSwap", doWrap); 
        
        // 頁面載入時檢查當前路徑，決定是否顯示導航列和啟動 Tab 邏輯
        document.addEventListener('DOMContentLoaded', () => {
            const path = window.location.pathname;
            const body = document.body;

            const isCardPage = path === '/' || path === '/signup' || path === '/login'; 
            const isAppPage = path.startsWith('/app/');

            if (isCardPage) { 
                body.classList.add('no-nav');
            } else if (isAppPage) { 
                body.classList.remove('no-nav');
            }

            // 處理 Tab 點擊事件 (僅在 App 頁面需要)
            if (isAppPage) { 
                const tabs = document.querySelectorAll('#navbar .nav-link');
                const tabContent = document.getElementById('tab-content'); 

                tabs.forEach(tab => {
                    tab.addEventListener('click', function (e) {
                        e.preventDefault();
                        const url = this.getAttribute('data-content-url');

                        tabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');

                        htmx.ajax('GET', url, { target: '#tab-content', swap: 'innerHTML' });

                        history.replaceState(null, '', path + this.getAttribute('href'));
                    });
                });

                // 初始載入 Tab 內容 (預設載入第一個 Tab 的內容)
                const initialTab = tabs[0];
                if (initialTab && tabContent) {
                    const initialUrl = initialTab.getAttribute('data-content-url');
                    // 由於 HTMX 腳本現在已正確引入，這裡的判斷應該會成功
                    if (htmx) { 
                        htmx.ajax('GET', initialUrl, { target: '#tab-content', swap: 'innerHTML' });
                        history.replaceState(null, '', path + initialTab.getAttribute('href'));
                    }
                }
            }
        });
    </script>

</body>

</html>