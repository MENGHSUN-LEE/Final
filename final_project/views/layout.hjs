<!DOCTYPE html>
<html lang="zh-TW">
<script src="/htmx.min.js"></script>
<script src="/response-targets.min.js"></script>
<script src="/remove-me.js"></script>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            margin: 0;
            width: 100%;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            /* (1) 預設為首頁的卡片樣式 (較小) */
            max-width: 600px;
            min-height: 50vh;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            margin: auto;
            transition: max-width 0.5s, min-height 0.5s, box-shadow 0.5s;
        }

        /* -------------------------------------- */
        /* (2) 針對主功能頁面（/app），將容器放大至全螢幕 */
        body:not(.no-nav) #main {
            align-items: flex-start;
            /* 讓內容從頂部開始 */
            justify-content: flex-start;
            /* 讓內容靠左開始 */
            padding: 0;
            /* 移除外層 padding，讓 Tab 內容區域貼邊 */
        }

        /* (3) 調整主內容區 #main 在全螢幕模式下的行為 */
        body:not(.no-nav) #app-container {
            max-width: 100vw;
            /* 確保全寬度，覆寫 max-width: 600px; [cite: 7] */
            min-height: 100vh;
            /* 確保全高度，覆寫 min-height: 50vh; [cite: 8] */
            margin: 0;
            /* 移除 auto margin */
            box-shadow: none;
            /* 移除卡片陰影，覆寫 box-shadow [cite: 8] */
        }

        /* 讓 Tab 內容區域佔滿 #main 空間，並在內部添加 padding */
        #tab-content {
            padding: 20px;
            /* 這裡才是 Tab 內容的邊距 */
            width: 100%;
            box-sizing: border-box;
            /* 確保在全螢幕模式下佔滿剩餘高度 (選用) */
            flex-grow: 1;
        }

        /* -------------------------------------- */

        #main {
            display: flex;
            flex-grow: 1;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        #navbar {
            background-color: #343a40;
            /* 深色背景 */
            padding: 10px 20px;
            display: flex;
            justify-content: flex-start;
            /* 讓 Tab 靠左對齊 */
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            /* 確保在 /app 頁面時，它位於 #app-container 的頂部 */
            flex-shrink: 0;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            margin: 0;
        }

        /* ... (Navbar 樣式保持不變) ... */

        /* -------------------------------------- */
        /* Start 按鈕放大置中樣式 (來自上一個步驟) */
        .actions {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #startBtn {
            padding: 15px 40px !important;
            font-size: 20px;
            width: auto !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* -------------------------------------- */
        /* 新增: 處理隱藏導航列的樣式 */
        .no-nav #navbar,
        .no-nav #tab-content {
            /* Tab Content 也要隱藏 */
            display: none;
        }

        /* 在沒有導航列時，主內容區域需要獨佔整個 #app-container */
        .no-nav #main {
            align-items: center;
            /* 讓首頁內容在容器內垂直置中 */
            justify-content: center;
            height: 100%;
            /* 確保 main 佔滿空間 */
        }

        /* -------------------------------------- */

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-right: 10px;
            /* 增加 Tab 之間的間距 */
            font-weight: bold;
        }

        .nav-link.active,
        .nav-link:hover {
            background-color: #007bff;
            color: white;
        }

        /* ... (其他 CSS 樣式保持不變) ... */
    </style>
</head>

<body hx-ext="response-targets, remove-me" hx-target-error="#toast" hx-on::before-swap="doWrap(event)">

    <div id="app-container">
        {{!-- <nav id="navbar">
            <a id="tab-search" class="nav-link active" href="#search" data-content-url="/search">
                <i class="fa-solid fa-magnifying-glass"></i> 搜尋
            </a>
            <a id="tab-edit" class="nav-link" href="#edit" data-content-url="/edit">
                <i class="fa-solid fa-pen-to-square"></i> 編輯
            </a>
            <a id="tab-custom" class="nav-link" href="#custom" data-content-url="/custom">
                <i class="fa-solid fa-chart-line"></i> 自選功能
            </a>
        </nav> --}}

        <div id="app-container">
            <nav id="navbar">
                {{{navbar_content}}}
            </nav>

            <main id="main">
                {{{body}}}
            </main>
        </div>

        <div id="toast"></div>

        <script>
            function doWrap(e) {
                if (e.detail.isError) {
                    e.detail.serverResponse = `<div remove-me="10s" style="background-color: #dc3545c0; color: yellow;">${e.detail.serverResponse}</div>`;
                }
            }
            htmx.on("htmx:beforeSwap", doWrap);
            // 頁面載入時檢查當前路徑，決定是否顯示導航列和啟動 Tab 邏輯
            document.addEventListener('DOMContentLoaded', () => {
                // 檢查當前路徑是否為獨立頁面 (首頁, 註冊, 登入) 或應用程式頁面 "/app/*"
                const path = window.location.pathname;
                const body = document.body;

                // 判斷是否為獨立的卡片頁面：首頁 "/", 註冊 "/signup", 登入 "/login"
                const isCardPage = path === '/' || path === '/signup' || path === '/login'; // <-- 新增 '/login'

                const isAppPage = path.startsWith('/app/');

                if (isCardPage) { // 如果是獨立卡片頁面，則添加 no-nav 類別 (隱藏 Navbar + 置中)
                    body.classList.add('no-nav');
                } else if (isAppPage) { // App 頁面顯示導航列，並套用全螢幕樣式
                    body.classList.remove('no-nav');
                }

                // 處理 Tab 點擊事件 (僅在 App 頁面需要)
                if (isAppPage) { // <-- 使用 isAppPage 來判斷是否執行 Tab 邏輯
                    const tabs = document.querySelectorAll('#navbar .nav-link');
                    const tabContent = document.getElementById('tab-content'); // <-- 確保這個 ID 是正確的

                    tabs.forEach(tab => {
                        tab.addEventListener('click', function (e) {
                            e.preventDefault();
                            const url = this.getAttribute('data-content-url');

                            // 移除所有 active 狀態，並為當前點擊的 Tab 加上 active 狀態
                            tabs.forEach(t => t.classList.remove('active'));
                            this.classList.add('active');

                            // 使用 htmx 載入內容到 #tab-content
                            htmx.ajax('GET', url, { target: '#tab-content', swap: 'innerHTML' });

                            // 更新 URL Hash，保持狀態
                            // 例如：/app/user#search 或 /app/guest#edit
                            history.replaceState(null, '', path + this.getAttribute('href'));
                        });
                    });

                    // 初始載入 Tab 內容 (預設載入第一個 Tab 的內容)
                    const initialTab = tabs[0];
                    if (initialTab && tabContent) {
                        const initialUrl = initialTab.getAttribute('data-content-url');
                        if (htmx) {
                            htmx.ajax('GET', initialUrl, { target: '#tab-content', swap: 'innerHTML' });
                            // 設置初始 URL Hash
                            history.replaceState(null, '', path + initialTab.getAttribute('href'));
                        }
                    }
                }
            });
        </script>
</body>

</html>